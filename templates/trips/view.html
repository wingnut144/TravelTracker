{% extends "base.html" %}

{% block title %}{{ trip.title }} - Travel Tracker{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('trips') }}">Trips</a></li>
                <li class="breadcrumb-item active">{{ trip.title }}</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row mb-4">
    <div class="col">
        <h1>
            <i class="bi bi-suitcase-lg"></i> {{ trip.title }}
            {% if trip|trip_status == 'upcoming' %}
                <span class="badge badge-upcoming">Upcoming</span>
            {% elif trip|trip_status == 'current' %}
                <span class="badge badge-current">In Progress</span>
            {% else %}
                <span class="badge badge-past">Completed</span>
            {% endif %}
            
            {% if trip.auto_detected %}
                <span class="badge bg-warning text-dark">
                    <i class="bi bi-robot"></i> Auto-detected
                </span>
            {% endif %}
        </h1>
        <p class="lead">
            <i class="bi bi-geo-alt"></i> {{ trip.destination }}
        </p>
    </div>
    {% if can_edit %}
    <div class="col-auto">
        <a href="{{ url_for('edit_trip', trip_id=trip.id) }}" class="btn btn-primary">
            <i class="bi bi-pencil"></i> Edit
        </a>
        <a href="{{ url_for('share_trip', trip_id=trip.id) }}" class="btn btn-outline-primary">
            <i class="bi bi-share"></i> Share
        </a>
    </div>
    {% endif %}
</div>

<!-- Trip Details -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-info-circle"></i> Trip Details</h5>
                
                <dl class="row mb-0">
                    <dt class="col-sm-3">Dates:</dt>
                    <dd class="col-sm-9">
                        <i class="bi bi-calendar3"></i>
                        {{ trip.start_date.strftime('%B %d, %Y') }} - {{ trip.end_date.strftime('%B %d, %Y') }}
                    </dd>
                    
                    <dt class="col-sm-3">Duration:</dt>
                    <dd class="col-sm-9">
                        {{ (trip.end_date - trip.start_date).days + 1 }} days
                    </dd>
                    
                    <dt class="col-sm-3">Visibility:</dt>
                    <dd class="col-sm-9">
                        {% if trip.visibility.value == 'private' %}
                            <span class="badge bg-secondary"><i class="bi bi-lock"></i> Private</span>
                        {% elif trip.visibility.value == 'shared' %}
                            <span class="badge bg-info"><i class="bi bi-people"></i> Shared</span>
                        {% else %}
                            <span class="badge bg-success"><i class="bi bi-globe"></i> Public</span>
                        {% endif %}
                    </dd>
                    
                    {% if trip.description %}
                    <dt class="col-sm-3">Description:</dt>
                    <dd class="col-sm-9">{{ trip.description }}</dd>
                    {% endif %}
                    
                    {% if trip.confirmation_number %}
                    <dt class="col-sm-3">Confirmation:</dt>
                    <dd class="col-sm-9"><code>{{ trip.confirmation_number }}</code></dd>
                    {% endif %}
                </dl>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-bar-chart"></i> Statistics</h5>
                
                <div class="d-flex justify-content-between mb-2">
                    <span><i class="bi bi-airplane"></i> Flights:</span>
                    <strong>{{ trip.flights|length }}</strong>
                </div>
                
                <div class="d-flex justify-content-between mb-2">
                    <span><i class="bi bi-building"></i> Accommodations:</span>
                    <strong>{{ trip.accommodations|length }}</strong>
                </div>
                
                {% if photos %}
                <div class="d-flex justify-content-between mb-2">
                    <span><i class="bi bi-camera"></i> Photos:</span>
                    <strong>{{ photos|length }}</strong>
                </div>
                {% endif %}
                
                <div class="d-flex justify-content-between">
                    <span><i class="bi bi-share"></i> Shares:</span>
                    <strong>{{ trip.shares|length }}</strong>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Flights -->
{% if trip.flights %}
<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-airplane"></i> Flights</h5>
                {% if can_edit %}
                <a href="{{ url_for('add_flight', trip_id=trip.id) }}" class="btn btn-sm btn-primary">
                    <i class="bi bi-plus"></i> Add Flight
                </a>
                {% endif %}
            </div>
            <div class="card-body">
                {% for flight in trip.flights %}
                <div class="border rounded p-3 mb-3">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>{{ flight.airline }} {{ flight.flight_number }}</h6>
                            <p class="mb-1">
                                <strong>{{ flight.departure_airport }}</strong> 
                                <i class="bi bi-arrow-right"></i> 
                                <strong>{{ flight.arrival_airport }}</strong>
                            </p>
                            <p class="text-muted mb-0">
                                <small>
                                    <i class="bi bi-calendar3"></i>
                                    {{ flight.departure_time.strftime('%b %d, %Y at %I:%M %p') }}
                                </small>
                            </p>
                        </div>
                        <div class="col-md-6 text-md-end">
                            {% if flight.status %}
                            <span class="badge 
                                {% if flight.status == 'scheduled' %}bg-primary
                                {% elif flight.status == 'boarding' %}bg-warning
                                {% elif flight.status == 'departed' %}bg-info
                                {% elif flight.status == 'arrived' %}bg-success
                                {% elif flight.status == 'delayed' %}bg-warning
                                {% elif flight.status == 'cancelled' %}bg-danger
                                {% else %}bg-secondary
                                {% endif %}">
                                {{ flight.status|upper }}
                            </span>
                            {% endif %}
                            
                            {% if flight.seat_number %}
                            <p class="mb-1 mt-2">
                                <small><i class="bi bi-seat"></i> Seat: {{ flight.seat_number }}</small>
                            </p>
                            {% endif %}
                            
                            {% if flight.gate %}
                            <p class="mb-1">
                                <small><i class="bi bi-door-open"></i> Gate: {{ flight.gate }}</small>
                            </p>
                            {% endif %}
                            
                            {% if flight.confirmation_number %}
                            <p class="mb-0">
                                <small>Confirmation: <code>{{ flight.confirmation_number }}</code></small>
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% elif can_edit %}
<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-body text-center py-4">
                <i class="bi bi-airplane" style="font-size: 3rem; color: #6c757d;"></i>
                <h5 class="mt-3">No flights added yet</h5>
                <a href="{{ url_for('add_flight', trip_id=trip.id) }}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Add Flight
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Accommodations -->
{% if trip.accommodations %}
<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-building"></i> Accommodations</h5>
                {% if can_edit %}
                <a href="{{ url_for('add_accommodation', trip_id=trip.id) }}" class="btn btn-sm btn-primary">
                    <i class="bi bi-plus"></i> Add Accommodation
                </a>
                {% endif %}
            </div>
            <div class="card-body">
                {% for accommodation in trip.accommodations %}
                <div class="border rounded p-3 mb-3">
                    <h6>{{ accommodation.name }}</h6>
                    {% if accommodation.address %}
                    <p class="mb-1"><i class="bi bi-geo-alt"></i> {{ accommodation.address }}</p>
                    {% endif %}
                    <p class="text-muted mb-1">
                        <small>
                            <i class="bi bi-calendar-check"></i>
                            Check-in: {{ accommodation.check_in.strftime('%b %d, %Y') }}
                        </small>
                    </p>
                    <p class="text-muted mb-1">
                        <small>
                            <i class="bi bi-calendar-x"></i>
                            Check-out: {{ accommodation.check_out.strftime('%b %d, %Y') }}
                        </small>
                    </p>
                    {% if accommodation.confirmation_number %}
                    <p class="mb-0">
                        <small>Confirmation: <code>{{ accommodation.confirmation_number }}</code></small>
                    </p>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% elif can_edit %}
<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-body text-center py-4">
                <i class="bi bi-building" style="font-size: 3rem; color: #6c757d;"></i>
                <h5 class="mt-3">No accommodations added yet</h5>
                <a href="{{ url_for('add_accommodation', trip_id=trip.id) }}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Add Accommodation
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Photos (Immich Integration) -->
{% if photos %}
<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-camera"></i> Photos</h5>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    {% for photo in photos %}
                    <div class="col-6 col-md-3">
                        <img src="{{ photo.thumbnail_url }}" class="img-fluid rounded" alt="Trip photo">
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Foursquare Check-ins Map -->
{% if trip.checkins %}
<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-map"></i> Check-in Map
                </h5>
            </div>
            <div class="card-body p-0">
                <div id="checkin-map" style="height: 400px; width: 100%;"></div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Foursquare Check-ins -->
{% if trip.checkins %}
<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-geo-fill text-danger"></i> Check-ins
                    <span class="badge bg-secondary">{{ trip.checkins|length }}</span>
                </h5>
                {% if can_edit and current_user.user_settings and current_user.user_settings.foursquare_enabled %}
                <form method="POST" action="{{ url_for('manual_sync_checkins', trip_id=trip.id) }}" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-arrow-repeat"></i> Sync Now
                    </button>
                </form>
                {% endif %}
            </div>
            <div class="card-body">
                <div class="row g-3">
                    {% for checkin in trip.checkins|sort(attribute='checkin_time') %}
                    <div class="col-md-6 col-lg-3">
                        <div class="card h-100 shadow-sm">
                            <!-- Number badge -->
                            <div class="position-absolute top-0 start-0 m-2">
                                <span class="badge bg-primary" style="font-size: 1rem;">{{ loop.index }}</span>
                            </div>
                            
                            {% if checkin.photo_url %}
                            <img src="{{ checkin.photo_url }}" 
                                 class="card-img-top" 
                                 style="height: 150px; object-fit: cover;"
                                 alt="{{ checkin.venue_name }}">
                            {% else %}
                            <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 150px;">
                                <i class="bi bi-geo-alt-fill text-muted" style="font-size: 3rem;"></i>
                            </div>
                            {% endif %}
                            
                            <div class="card-body p-3">
                                <h6 class="card-title mb-2">
                                    <i class="bi bi-pin-map"></i> {{ checkin.venue_name }}
                                </h6>
                                
                                {% if checkin.venue_category %}
                                <p class="card-text small text-muted mb-1">
                                    <i class="bi bi-tag"></i> {{ checkin.venue_category }}
                                </p>
                                {% endif %}
                                
                                {% if checkin.venue_address %}
                                <p class="card-text small text-muted mb-1">
                                    <i class="bi bi-geo-alt"></i> {{ checkin.venue_address }}
                                </p>
                                {% endif %}
                                
                                <p class="card-text small text-muted mb-2">
                                    <i class="bi bi-clock"></i> {{ checkin.checkin_time.strftime('%b %d at %I:%M %p') }}
                                </p>
                                
                                {% if checkin.shout %}
                                <p class="card-text small fst-italic">
                                    "{{ checkin.shout }}"
                                </p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% elif can_edit and current_user.user_settings and current_user.user_settings.foursquare_enabled %}
<div class="row mb-4">
    <div class="col">
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> 
            No check-ins found for this trip. Check-ins are synced automatically every hour, or you can 
            <form method="POST" action="{{ url_for('manual_sync_checkins', trip_id=trip.id) }}" class="d-inline">
                <button type="submit" class="btn btn-sm btn-link p-0">sync now</button>
            </form>.
        </div>
    </div>
</div>
{% endif %}

<!-- Notes -->
{% if trip.notes %}
<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-journal-text"></i> Notes</h5>
            </div>
            <div class="card-body">
                {{ trip.notes|nl2br }}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Delete Button -->
{% if can_edit %}
<div class="row">
    <div class="col">
        <form method="POST" action="{{ url_for('delete_trip', trip_id=trip.id) }}" 
              onsubmit="return confirm('Are you sure you want to delete this trip? This action cannot be undone.');">
            <button type="submit" class="btn btn-danger">
                <i class="bi bi-trash"></i> Delete Trip
            </button>
        </form>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS for maps -->
{% if trip.checkins %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
      crossorigin=""/>
{% endif %}
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS for maps -->
{% if trip.checkins %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
        crossorigin=""></script>

<script>
// Initialize map when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Check if map element exists
    const mapElement = document.getElementById('checkin-map');
    if (!mapElement) return;
    
    // Create checkins data array
    const checkins = [
        {% for checkin in trip.checkins %}
        {% if checkin.latitude and checkin.longitude %}
        {
            lat: {{ checkin.latitude }},
            lng: {{ checkin.longitude }},
            name: "{{ checkin.venue_name|replace('"', '\\"') }}",
            category: "{{ checkin.venue_category|replace('"', '\\"') if checkin.venue_category else '' }}",
            address: "{{ checkin.venue_address|replace('"', '\\"') if checkin.venue_address else '' }}",
            time: "{{ checkin.checkin_time.strftime('%b %d, %Y at %I:%M %p') }}",
            shout: "{{ checkin.shout|replace('"', '\\"') if checkin.shout else '' }}"
        },
        {% endif %}
        {% endfor %}
    ];
    
    if (checkins.length === 0) {
        mapElement.innerHTML = '<div class="p-4 text-center text-muted">No check-ins with location data</div>';
        return;
    }
    
    // Calculate center and bounds
    const lats = checkins.map(c => c.lat);
    const lngs = checkins.map(c => c.lng);
    const centerLat = (Math.max(...lats) + Math.min(...lats)) / 2;
    const centerLng = (Math.max(...lngs) + Math.min(...lngs)) / 2;
    
    // Initialize map
    const map = L.map('checkin-map').setView([centerLat, centerLng], 13);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
    }).addTo(map);
    
    // Add markers for each check-in
    // Add markers for each check-in with numbers
    const markers = [];
    checkins.forEach(function(checkin, index) {
        // Create numbered icon
        const numberIcon = L.divIcon({
            html: `<div style="background-color: #0d6efd; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">${index + 1}</div>`,
            iconSize: [30, 30],
            className: 'numbered-marker'
        });
        
        const marker = L.marker([checkin.lat, checkin.lng], {icon: numberIcon}).addTo(map);
        
        // Create popup content
        let popupContent = '<div style="min-width: 200px;">';
        popupContent += '<h6 class="mb-1"><span class="badge bg-primary me-1">' + (index + 1) + '</span><strong>' + checkin.name + '</strong></h6>';
        
        if (checkin.category) {
            popupContent += '<p class="mb-1 small text-muted"><i class="bi bi-tag"></i> ' + checkin.category + '</p>';
        }
        
        if (checkin.address) {
            popupContent += '<p class="mb-1 small text-muted"><i class="bi bi-geo-alt"></i> ' + checkin.address + '</p>';
        }
        
        popupContent += '<p class="mb-1 small text-muted"><i class="bi bi-clock"></i> ' + checkin.time + '</p>';
        
        if (checkin.shout) {
            popupContent += '<p class="mb-0 small fst-italic">"' + checkin.shout + '"</p>';
        }
        
        popupContent += '</div>';
        
        marker.bindPopup(popupContent);
        markers.push(marker);
    });
    
    // Fit map to show all markers
    if (markers.length > 1) {
        const group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.1));
    }
    
    // Add trip start location if available
    {% if trip.destination_latitude and trip.destination_longitude %}
    const tripIcon = L.divIcon({
        html: '<i class="bi bi-pin-map-fill text-primary" style="font-size: 24px;"></i>',
        iconSize: [24, 24],
        className: 'trip-marker'
    });
    
    L.marker([{{ trip.destination_latitude }}, {{ trip.destination_longitude }}], {icon: tripIcon})
        .addTo(map)
        .bindPopup('<div><h6><strong>{{ trip.destination|replace("'", "\\'") }}</strong></h6><p class="mb-0 small">Trip Destination</p></div>');
    {% endif %}
});
</script>
{% endif %}
<!-- Accommodations Section -->
{% if trip.accommodations %}
<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-house-door"></i> Accommodations
                </h5>
                {% if can_edit %}
                <a href="{{ url_for('add_accommodation', trip_id=trip.id) }}" class="btn btn-sm btn-primary">
                    <i class="bi bi-plus-circle"></i> Add Accommodation
                </a>
                {% endif %}
            </div>
            <div class="card-body">
                {% for accommodation in trip.accommodations %}
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h5 class="card-title">
                                    <i class="bi bi-{% if accommodation.accommodation_type == 'airbnb' %}house-heart{% elif accommodation.accommodation_type == 'hotel' %}building{% else %}house-door{% endif %}"></i>
                                    {{ accommodation.name }}
                                    <span class="badge bg-secondary ms-2">{{ accommodation.accommodation_type|title }}</span>
                                </h5>
                                
                                {% if accommodation.address %}
                                <p class="card-text mb-1">
                                    <i class="bi bi-geo-alt"></i> {{ accommodation.address }}
                                </p>
                                {% endif %}
                                
                                <p class="card-text mb-1">
                                    <i class="bi bi-calendar-check"></i> 
                                    Check-in: {{ accommodation.check_in.strftime('%b %d, %Y') }}
                                    <span class="mx-2">|</span>
                                    <i class="bi bi-calendar-x"></i> 
                                    Check-out: {{ accommodation.check_out.strftime('%b %d, %Y') }}
                                </p>
                                
                                {% if accommodation.confirmation_number %}
                                <p class="card-text mb-1">
                                    <i class="bi bi-receipt"></i> 
                                    Confirmation: <code>{{ accommodation.confirmation_number }}</code>
                                </p>
                                {% endif %}
                                
                                {% if accommodation.notes %}
                                <p class="card-text small text-muted mt-2">
                                    <i class="bi bi-sticky"></i> {{ accommodation.notes }}
                                </p>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-4 text-end">
                                {% if accommodation.cost %}
                                <h3 class="text-success mb-3">${{ '%.2f'|format(accommodation.cost) }}</h3>
                                {% endif %}
                                
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% elif can_edit %}
<div class="row mb-4">
    <div class="col">
        <div class="alert alert-info">
            <i class="bi bi-house-door"></i> 
            No accommodations added yet. 
            <a href="{{ url_for('add_accommodation', trip_id=trip.id) }}" class="alert-link">Add your first accommodation</a>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
