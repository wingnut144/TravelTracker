{% extends "base.html" %}
{% block title %}Add Flight - Travel Tracker{% endblock %}
{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('view_trip', trip_id=trip.id) }}">{{ trip.title }}</a></li>
            <li class="breadcrumb-item active">Add Flight</li>
        </ol>
    </nav>

    <h1><i class="bi bi-airplane"></i> Add Flight</h1>

    <!-- Step 1: Flight Lookup -->
    <div id="lookupSection" class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5><i class="bi bi-search"></i> Find Your Flight</h5>
        </div>
        <div class="card-body">
            <p class="text-muted">Enter your confirmation number and select your airline. We'll automatically fill in your flight details!</p>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="airline" class="form-label">Airline *</label>
                    <select class="form-select" id="airline" required>
                        <option value="">Select Airline...</option>
                        <option value="AA">American Airlines</option>
                        <option value="DL">Delta Air Lines</option>
                        <option value="UA">United Airlines</option>
                        <option value="WN">Southwest Airlines</option>
                        <option value="B6">JetBlue Airways</option>
                        <option value="AS">Alaska Airlines</option>
                        <option value="F9">Frontier Airlines</option>
                        <option value="NK">Spirit Airlines</option>
                    </select>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="confirmationNumber" class="form-label">Confirmation Number *</label>
                    <input type="text" class="form-control text-uppercase" id="confirmationNumber" 
                           placeholder="e.g., ABC123" required>
                    <small class="text-muted">Usually 6 characters (letters and numbers)</small>
                </div>
            </div>

            <button type="button" class="btn btn-primary" onclick="lookupFlight()">
                <i class="bi bi-search"></i> Find Flight
            </button>
            
            <button type="button" class="btn btn-outline-secondary" onclick="showManualForm()">
                <i class="bi bi-pencil"></i> Enter Manually
            </button>

            <div id="lookupStatus" class="mt-3"></div>
        </div>
    </div>

    <!-- Step 2: Flight Details Form -->
    <form method="POST" id="flightForm" style="display: none;">
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="bi bi-airplane"></i> Flight Details</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="airlineDisplay" class="form-label">Airline *</label>
                        <input type="text" class="form-control" id="airlineDisplay" name="airline" required>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="flight_number" class="form-label">Flight Number *</label>
                        <input type="text" class="form-control" id="flight_number" name="flight_number" 
                               placeholder="e.g., UA123" required>
                    </div>
                </div>
            </div>
        </div>

        <!-- Departure Section -->
        <div class="card mb-4 border-primary">
            <div class="card-header bg-primary text-white">
                <h5><i class="bi bi-airplane-engines"></i> Departure</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="departure_airport" class="form-label">Airport Code *</label>
                        <input type="text" class="form-control text-uppercase" id="departure_airport" 
                               name="departure_airport" placeholder="E.G., SFO" maxlength="3" required>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="departure_terminal" class="form-label">Terminal</label>
                        <input type="text" class="form-control" id="departure_terminal" 
                               name="departure_terminal" placeholder="e.g., 2, T3">
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="departure_time" class="form-label">Date & Time *</label>
                        <input type="datetime-local" class="form-control" id="departure_time" 
                               name="departure_time" required>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="departure_gate" class="form-label">Gate</label>
                        <input type="text" class="form-control" id="departure_gate" 
                               name="departure_gate" placeholder="e.g., B12">
                    </div>
                </div>
            </div>
        </div>

        <!-- Arrival Section -->
        <div class="card mb-4 border-success">
            <div class="card-header bg-success text-white">
                <h5><i class="bi bi-airplane-fill"></i> Arrival</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="arrival_airport" class="form-label">Airport Code *</label>
                        <input type="text" class="form-control text-uppercase" id="arrival_airport" 
                               name="arrival_airport" placeholder="E.G., LAX" maxlength="3" required>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="arrival_terminal" class="form-label">Terminal</label>
                        <input type="text" class="form-control" id="arrival_terminal" 
                               name="arrival_terminal" placeholder="e.g., 1, T2">
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="arrival_time" class="form-label">Date & Time *</label>
                        <input type="datetime-local" class="form-control" id="arrival_time" 
                               name="arrival_time" required>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="arrival_gate" class="form-label">Gate</label>
                        <input type="text" class="form-control" id="arrival_gate" 
                               name="arrival_gate" placeholder="e.g., A5">
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Details -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="bi bi-info-circle"></i> Additional Details</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="confirmation_number" class="form-label">Confirmation Number</label>
                        <input type="text" class="form-control" id="confirmation_number" 
                               name="confirmation_number">
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="seat_number" class="form-label">Seat</label>
                        <input type="text" class="form-control" id="seat_number" 
                               name="seat_number" placeholder="e.g., 12A">
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="cost" class="form-label">Cost</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="cost" name="cost" 
                                   step="0.01" min="0" placeholder="0.00">
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="notes" class="form-label">Notes</label>
                    <textarea class="form-control" id="notes" name="notes" rows="3" 
                              placeholder="Any additional notes..."></textarea>
                </div>
            </div>
        </div>

        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-success">
                <i class="bi bi-check-circle"></i> Add Flight
            </button>
            <a href="{{ url_for('view_trip', trip_id=trip.id) }}" class="btn btn-secondary">
                <i class="bi bi-x-circle"></i> Cancel
            </a>
            <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                <i class="bi bi-arrow-counterclockwise"></i> Start Over
            </button>
        </div>
    </form>
</div>

<script>
function lookupFlight() {
    const airline = document.getElementById('airline').value;
    const confirmationNumber = document.getElementById('confirmationNumber').value.toUpperCase();
    const statusDiv = document.getElementById('lookupStatus');
    
    if (!airline || !confirmationNumber) {
        statusDiv.innerHTML = '<div class="alert alert-warning">Please select an airline and enter a confirmation number.</div>';
        return;
    }
    
    statusDiv.innerHTML = '<div class="alert alert-info"><i class="bi bi-hourglass-split"></i> Looking up your flight...</div>';
    
    fetch(`/api/flights/lookup?airline=${airline}&confirmation=${confirmationNumber}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Fill in the form with API data
                document.getElementById('airlineDisplay').value = data.flight.airline_name || airline;
                document.getElementById('flight_number').value = data.flight.flight_number || '';
                document.getElementById('departure_airport').value = data.flight.departure_airport || '';
                document.getElementById('arrival_airport').value = data.flight.arrival_airport || '';
                document.getElementById('departure_time').value = data.flight.departure_time || '';
                document.getElementById('arrival_time').value = data.flight.arrival_time || '';
                document.getElementById('departure_terminal').value = data.flight.departure_terminal || '';
                document.getElementById('arrival_terminal').value = data.flight.arrival_terminal || '';
                document.getElementById('departure_gate').value = data.flight.departure_gate || '';
                document.getElementById('arrival_gate').value = data.flight.arrival_gate || '';
                document.getElementById('confirmation_number').value = confirmationNumber;
                
                // Hide lookup, show form
                document.getElementById('lookupSection').style.display = 'none';
                document.getElementById('flightForm').style.display = 'block';
                statusDiv.innerHTML = '';
            } else {
                statusDiv.innerHTML = `<div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> ${data.message || 'Could not find flight details.'}
                    <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="showManualForm()">Enter Manually</button>
                </div>`;
            }
        })
        .catch(error => {
            statusDiv.innerHTML = `<div class="alert alert-danger">
                <i class="bi bi-x-circle"></i> Error looking up flight. 
                <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="showManualForm()">Enter Manually</button>
            </div>`;
        });
}

function showManualForm() {
    const airline = document.getElementById('airline').value;
    const confirmationNumber = document.getElementById('confirmationNumber').value;
    
    // Pre-fill what we have
    if (airline) {
        const airlineNames = {
            'AA': 'American Airlines',
            'DL': 'Delta Air Lines',
            'UA': 'United Airlines',
            'WN': 'Southwest Airlines',
            'B6': 'JetBlue Airways',
            'AS': 'Alaska Airlines',
            'F9': 'Frontier Airlines',
            'NK': 'Spirit Airlines'
        };
        document.getElementById('airlineDisplay').value = airlineNames[airline] || airline;
    }
    
    if (confirmationNumber) {
        document.getElementById('confirmation_number').value = confirmationNumber.toUpperCase();
    }
    
    document.getElementById('lookupSection').style.display = 'none';
    document.getElementById('flightForm').style.display = 'block';
}

function resetForm() {
    document.getElementById('lookupSection').style.display = 'block';
    document.getElementById('flightForm').style.display = 'none';
    document.getElementById('lookupStatus').innerHTML = '';
    document.getElementById('airline').value = '';
    document.getElementById('confirmationNumber').value = '';
    document.getElementById('flightForm').reset();
}
</script>
{% endblock %}
