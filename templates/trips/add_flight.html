{% extends "base.html" %}
{% block title %}Add Flight - Travel Tracker{% endblock %}
{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('view_trip', trip_id=trip.id) }}">{{ trip.title }}</a></li>
            <li class="breadcrumb-item active">Add Flight</li>
        </ol>
    </nav>

    <h1><i class="bi bi-airplane"></i> Add Flight</h1>

    <!-- Step 1: Flight Lookup -->
    <div id="lookupSection" class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5><i class="bi bi-search"></i> Find Your Flight</h5>
        </div>
        <div class="card-body">
            <p class="text-muted">Enter your flight number and date. We'll automatically retrieve your flight details!</p>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="flightNumber" class="form-label">Flight Number *</label>
                    <input type="text" class="form-control text-uppercase" id="flightNumber" 
                           placeholder="e.g., UA123, DL456, AA789" required>
                    <small class="text-muted">Include airline code (e.g., UA123, not just 123)</small>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="flightDate" class="form-label">Flight Date *</label>
                    <input type="date" class="form-control" id="flightDate" required>
                    <small class="text-muted">Date of departure</small>
                </div>
            </div>

            <button type="button" class="btn btn-primary btn-lg" onclick="lookupFlight()">
                <i class="bi bi-search"></i> Find My Flight
            </button>
            
            <button type="button" class="btn btn-outline-secondary" onclick="showManualForm()">
                <i class="bi bi-pencil"></i> Enter Manually Instead
            </button>

            <div id="lookupStatus" class="mt-3"></div>
        </div>
    </div>

    <!-- Step 2: Flight Details Form -->
    <form method="POST" id="flightForm" style="display: none;">
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5><i class="bi bi-airplane"></i> Flight Details</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="airline" class="form-label">Airline *</label>
                        <input type="text" class="form-control" id="airline" name="airline" required>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="flight_number" class="form-label">Flight Number *</label>
                        <input type="text" class="form-control" id="flight_number" name="flight_number" required>
                    </div>
                </div>
            </div>
        </div>

        <!-- Departure Section -->
        <div class="card mb-4 border-primary">
            <div class="card-header bg-primary text-white">
                <h5><i class="bi bi-airplane-engines"></i> Departure</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="departure_airport" class="form-label">Airport Code *</label>
                        <input type="text" class="form-control text-uppercase" id="departure_airport" 
                               name="departure_airport" placeholder="SFO" maxlength="3" required>
                        <small class="text-muted" id="departure_info"></small>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="departure_terminal" class="form-label">Terminal</label>
                        <input type="text" class="form-control" id="departure_terminal" 
                               name="departure_terminal" placeholder="2">
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="departure_time" class="form-label">Date & Time *</label>
                        <input type="datetime-local" class="form-control" id="departure_time" 
                               name="departure_time" required>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="departure_gate" class="form-label">Gate</label>
                        <input type="text" class="form-control" id="departure_gate" 
                               name="departure_gate" placeholder="B12">
                    </div>
                </div>
            </div>
        </div>

        <!-- Arrival Section -->
        <div class="card mb-4 border-success">
            <div class="card-header bg-success text-white">
                <h5><i class="bi bi-airplane-fill"></i> Arrival</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="arrival_airport" class="form-label">Airport Code *</label>
                        <input type="text" class="form-control text-uppercase" id="arrival_airport" 
                               name="arrival_airport" placeholder="LAX" maxlength="3" required>
                        <small class="text-muted" id="arrival_info"></small>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="arrival_terminal" class="form-label">Terminal</label>
                        <input type="text" class="form-control" id="arrival_terminal" 
                               name="arrival_terminal" placeholder="1">
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="arrival_time" class="form-label">Date & Time *</label>
                        <input type="datetime-local" class="form-control" id="arrival_time" 
                               name="arrival_time" required>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="arrival_gate" class="form-label">Gate</label>
                        <input type="text" class="form-control" id="arrival_gate" 
                               name="arrival_gate" placeholder="A5">
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Details -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="bi bi-info-circle"></i> Additional Details</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="confirmation_number" class="form-label">Confirmation Number</label>
                        <input type="text" class="form-control" id="confirmation_number" 
                               name="confirmation_number" placeholder="ABC123">
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="seat_number" class="form-label">Seat</label>
                        <input type="text" class="form-control" id="seat_number" 
                               name="seat_number" placeholder="12A">
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="cost" class="form-label">Cost</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="cost" name="cost" 
                                   step="0.01" min="0" placeholder="0.00">
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="notes" class="form-label">Notes</label>
                    <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                </div>
            </div>
        </div>

        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-success btn-lg">
                <i class="bi bi-check-circle"></i> Add Flight
            </button>
            <a href="{{ url_for('view_trip', trip_id=trip.id) }}" class="btn btn-secondary">
                <i class="bi bi-x-circle"></i> Cancel
            </a>
            <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                <i class="bi bi-arrow-counterclockwise"></i> Start Over
            </button>
        </div>
    </form>
</div>

<script>
function lookupFlight() {
    const flightNumber = document.getElementById('flightNumber').value.toUpperCase().trim();
    const flightDate = document.getElementById('flightDate').value;
    const statusDiv = document.getElementById('lookupStatus');
    
    if (!flightNumber || !flightDate) {
        statusDiv.innerHTML = '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> Please enter both flight number and date.</div>';
        return;
    }
    
    statusDiv.innerHTML = '<div class="alert alert-info"><i class="bi bi-hourglass-split"></i> Looking up your flight details...</div>';
    
    fetch('/api/flights/lookup?flight_number=' + flightNumber + '&date=' + flightDate)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('airline').value = data.flight.airline || '';
                document.getElementById('flight_number').value = data.flight.flight_number || flightNumber;
                document.getElementById('departure_airport').value = data.flight.departure_airport || '';
                document.getElementById('arrival_airport').value = data.flight.arrival_airport || '';
                document.getElementById('departure_time').value = data.flight.departure_time || '';
                document.getElementById('arrival_time').value = data.flight.arrival_time || '';
                document.getElementById('departure_terminal').value = data.flight.departure_terminal || '';
                document.getElementById('arrival_terminal').value = data.flight.arrival_terminal || '';
                document.getElementById('departure_gate').value = data.flight.departure_gate || '';
                document.getElementById('arrival_gate').value = data.flight.arrival_gate || '';
                
                if (data.flight.departure_city && data.flight.departure_name) {
                    const depCity = data.flight.departure_city;
                    const depName = data.flight.departure_name;
                    if (depName.includes(depCity)) {
                        document.getElementById('departure_info').textContent = depName;
                    } else {
                        document.getElementById('departure_info').textContent = depCity + ' - ' + depName;
                    }
                }
                
                if (data.flight.arrival_city && data.flight.arrival_name) {
                    const arrCity = data.flight.arrival_city;
                    const arrName = data.flight.arrival_name;
                    if (arrName.includes(arrCity)) {
                        document.getElementById('arrival_info').textContent = arrName;
                    } else {
                        document.getElementById('arrival_info').textContent = arrCity + ' - ' + arrName;
                    }
                }
                
                document.getElementById('lookupSection').style.display = 'none';
                document.getElementById('flightForm').style.display = 'block';
                statusDiv.innerHTML = '<div class="alert alert-success"><i class="bi bi-check-circle"></i> Flight found! Review and edit details below.</div>';
                window.scrollTo(0, 0);
            } else {
                statusDiv.innerHTML = '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> ' + (data.message || 'Could not find flight details.') + ' <button type="button" class="btn btn-sm btn-warning ms-2" onclick="showManualForm()">Enter Manually</button></div>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            statusDiv.innerHTML = '<div class="alert alert-danger"><i class="bi bi-x-circle"></i> Error looking up flight. <button type="button" class="btn btn-sm btn-danger ms-2" onclick="showManualForm()">Enter Manually</button></div>';
        });
}

function showManualForm() {
    const flightNumber = document.getElementById('flightNumber').value.toUpperCase();
    if (flightNumber) {
        document.getElementById('flight_number').value = flightNumber;
    }
    document.getElementById('lookupSection').style.display = 'none';
    document.getElementById('flightForm').style.display = 'block';
    window.scrollTo(0, 0);
}

function resetForm() {
    document.getElementById('lookupSection').style.display = 'block';
    document.getElementById('flightForm').style.display = 'none';
    document.getElementById('lookupStatus').innerHTML = '';
    document.getElementById('flightNumber').value = '';
    document.getElementById('flightDate').value = '';
    document.getElementById('flightForm').reset();
    document.getElementById('departure_info').textContent = '';
    document.getElementById('arrival_info').textContent = '';
    window.scrollTo(0, 0);
}

document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('flightDate').value = today;
});
</script>
{% endblock %}
