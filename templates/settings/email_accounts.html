{% extends "base.html" %}

{% block title %}Email Accounts - Travel Tracker{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('settings') }}">Settings</a></li>
                <li class="breadcrumb-item active">Email Accounts</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row mb-4">
    <div class="col">
        <h1><i class="bi bi-envelope"></i> Email Accounts</h1>
        <p class="lead">Connect your email to automatically import flight confirmations</p>
    </div>
</div>

{% if not current_user.user_settings.email_integration_enabled %}
<div class="alert alert-warning">
    <i class="bi bi-exclamation-triangle"></i> Email integration is currently disabled for your account. 
    Please contact an administrator to enable this feature.
</div>
{% endif %}

<!-- Setup Progress -->
<div class="card mb-4">
    <div class="card-body">
        <h5><i class="bi bi-list-check"></i> Setup Progress</h5>
        <div class="progress" style="height: 30px;">
            {% set progress = 0 %}
            {% if current_user.user_settings.has_google_oauth() or current_user.user_settings.has_microsoft_oauth() %}
                {% set progress = 50 %}
            {% endif %}
            {% if accounts %}
                {% set progress = 100 %}
            {% endif %}
            
            <div class="progress-bar" role="progressbar" style="width: {{ progress }}%;" 
                 aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100">
                {{ progress }}% Complete
            </div>
        </div>
        
        <div class="mt-3">
            <div class="d-flex align-items-center mb-2">
                {% if current_user.user_settings.has_google_oauth() or current_user.user_settings.has_microsoft_oauth() %}
                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                    <span>OAuth apps configured</span>
                {% else %}
                    <i class="bi bi-circle text-muted me-2"></i>
                    <span>Configure OAuth apps</span>
                {% endif %}
            </div>
            <div class="d-flex align-items-center">
                {% if accounts %}
                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                    <span>Email connected</span>
                {% else %}
                    <i class="bi bi-circle text-muted me-2"></i>
                    <span>Connect email account</span>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Connected Accounts -->
{% if accounts %}
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-envelope-check"></i> Connected Email Accounts</h5>
    </div>
    <div class="card-body">
        {% for account in accounts %}
        <div class="border rounded p-3 mb-3">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h6>
                        {% if account.email_type == 'gmail' %}
                            <i class="bi bi-google text-danger"></i> Gmail
                        {% else %}
                            <i class="bi bi-microsoft text-primary"></i> Outlook
                        {% endif %}
                    </h6>
                    <p class="mb-1"><strong>{{ account.email_address }}</strong></p>
                    <p class="mb-0 text-muted">
                        <small>
                            {% if account.is_active %}
                                <span class="badge bg-success">Active</span>
                            {% else %}
                                <span class="badge bg-secondary">Inactive</span>
                            {% endif %}
                            
                            {% if account.last_scan %}
                                Last scanned: {{ account.last_scan.strftime('%B %d, %Y at %I:%M %p') }}
                            {% else %}
                                Not yet scanned
                            {% endif %}
                        </small>
                    </p>
                </div>
                <div class="col-md-4 text-md-end">
                    <form method="POST" action="{{ url_for('disconnect_email_account', account_id=account.id) }}" 
                          onsubmit="return confirm('Disconnect {{ account.email_address }}?');" class="d-inline">
                        <button type="submit" class="btn btn-outline-danger">
                            <i class="bi bi-x-circle"></i> Disconnect
                        </button>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Connect New Account -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-plus-circle"></i> Connect Email Account</h5>
    </div>
    <div class="card-body">
        {% if not (current_user.user_settings.has_google_oauth() or current_user.user_settings.has_microsoft_oauth()) %}
        <div class="alert alert-info">
            <h6><i class="bi bi-info-circle"></i> First, set up your OAuth apps</h6>
            <p class="mb-0">
                Before connecting your email, you need to create OAuth applications. 
                This is a one-time setup that takes about 5 minutes.
            </p>
            <a href="{{ url_for('oauth_apps') }}" class="btn btn-primary mt-3">
                <i class="bi bi-key"></i> Set Up OAuth Apps
            </a>
        </div>
        {% else %}
        <p>Choose which email account to connect:</p>
        
        <div class="row">
            {% if current_user.user_settings.has_google_oauth() %}
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-google" style="font-size: 3rem; color: #db4437;"></i>
                        <h5 class="mt-3">Connect Gmail</h5>
                        <p class="text-muted">Scan your Gmail for flight confirmations</p>
                        
                        {% if accounts|selectattr('email_type', 'equalto', 'gmail')|list %}
                            <button class="btn btn-outline-secondary" disabled>
                                <i class="bi bi-check-circle"></i> Already Connected
                            </button>
                        {% else %}
                            <a href="{{ url_for('auth.google_auth') }}" class="btn btn-danger">
                                <i class="bi bi-envelope"></i> Connect Gmail
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if current_user.user_settings.has_microsoft_oauth() %}
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-microsoft" style="font-size: 3rem; color: #0078d4;"></i>
                        <h5 class="mt-3">Connect Outlook</h5>
                        <p class="text-muted">Scan your Outlook for flight confirmations</p>
                        
                        {% if accounts|selectattr('email_type', 'equalto', 'outlook')|list %}
                            <button class="btn btn-outline-secondary" disabled>
                                <i class="bi bi-check-circle"></i> Already Connected
                            </button>
                        {% else %}
                            <a href="{{ url_for('auth.microsoft_auth') }}" class="btn btn-primary">
                                <i class="bi bi-envelope"></i> Connect Outlook
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- How it Works -->
<div class="card bg-light">
    <div class="card-body">
        <h5><i class="bi bi-lightbulb"></i> How Email Scanning Works</h5>
        <ol class="mb-0">
            <li><strong>Automatic Scanning:</strong> We scan your email every 5 minutes for flight confirmations</li>
            <li><strong>Supported Airlines:</strong> United, American Airlines, Delta, Southwest (more coming soon)</li>
            <li><strong>Privacy First:</strong> Trips are created as private by default - you control who sees them</li>
            <li><strong>No Storage:</strong> We don't store your emails - only extract flight information</li>
            <li><strong>Your Control:</strong> Disconnect at any time, and scanning stops immediately</li>
        </ol>
    </div>
</div>

{% if accounts and current_user.user_settings.auto_scan_emails %}
<div class="alert alert-success mt-4">
    <i class="bi bi-check-circle"></i> <strong>Email scanning is active!</strong> 
    We'll automatically create trips when we find flight confirmations in your email.
    Check your <a href="{{ url_for('dashboard') }}" class="alert-link">dashboard</a> for auto-detected trips.
</div>
{% endif %}

{% endblock %}
